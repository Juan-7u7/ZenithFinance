<div class="dashboard-container">
  <!-- Header -->
  <header class="dashboard-header glass-card">
    <div class="user-welcome">
      @if (currentUser(); as user) {
        <div class="avatar-wrapper clickable" (click)="goToProfile()">
          @if (user.avatar && !avatarError()) {
            <img [src]="user.avatar" alt="Avatar" class="avatar" (error)="handleAvatarError()">
          } @else {
            <div class="avatar placeholder-avatar">
              {{ user.name.charAt(0).toUpperCase() }}
            </div>
          }
          <span class="status-indicator"></span>
        </div>
        <div class="user-info">
          <h1>{{ 'dashboard.welcome' | translate }}, {{ user.name }}</h1>
          <div class="date-header">
            <span class="day-tag">{{ currentDate | date:'EEEE' }}</span>
            <span class="date">{{ currentDate | date:'mediumDate' }}</span>
          </div>
        </div>
      } @else {
        <div class="user-welcome skeleton-loader">
          <div class="avatar-skeleton"></div>
          <div class="info-skeleton">
            <div class="line-skeleton title"></div>
            <div class="line-skeleton subtitle">
              <span class="loading-text">Obteniendo datos...</span>
            </div>
          </div>
        </div>
      }
    </div>
    
    <div class="actions">
      <button class="btn-icon-v2" (click)="goToCommunity()" [attr.data-tooltip]="'community.title' | translate">
        <lucide-icon [img]="icons.Users" class="icon-users"></lucide-icon>
      </button>
      <button class="btn-icon-v2" (click)="toggleAutomation()" data-tooltip="Automatizaciones">
        <lucide-icon [img]="icons.Zap" size="20"></lucide-icon>
      </button>
      <button class="btn-icon-v2 desktop-only" (click)="openWhatIfCalculator()" data-tooltip="Calculadora What-If">
        <lucide-icon [img]="icons.Calculator" size="20"></lucide-icon>
      </button>
      <button class="btn-icon-v2 desktop-only" (click)="exportToPDF()" data-tooltip="Exportar PDF">
        <lucide-icon [img]="icons.FileText" size="20"></lucide-icon>
      </button>
      <button class="btn-icon-v2 desktop-only" (click)="exportToCSV()" data-tooltip="Exportar CSV">
        <lucide-icon [img]="icons.Download" size="20"></lucide-icon>
      </button>
      <div class="notification-wrapper">
        <button class="btn-icon-v2" data-tooltip="Notificaciones" (click)="toggleNotifications($event)">
          <lucide-icon [img]="icons.Bell" class="icon-bell"></lucide-icon>
          <span class="notification-badge" *ngIf="unreadCount() > 0">{{ unreadCount() > 9 ? '9+' : unreadCount() }}</span>
        </button>
      </div>

      <button class="btn-icon-v2 lang-btn desktop-only" (click)="toggleLanguage()" [attr.data-tooltip]="'common.language' | translate">
        <lucide-icon [img]="icons.Languages" class="icon-lang"></lucide-icon>
        <span class="lang-code">{{ currentLang() | uppercase }}</span>
      </button>
      <button class="btn-icon-v2 desktop-only" (click)="toggleTheme()" [attr.data-tooltip]="'common.theme' | translate">
        <lucide-icon [img]="currentTheme() === 'light' ? icons.Moon : icons.Sun" class="icon-theme"></lucide-icon>
      </button>
      <button class="btn-icon-v2" (click)="logout()" [attr.data-tooltip]="'dashboard.logout' | translate">
        <lucide-icon [img]="icons.LogOut"></lucide-icon>
      </button>
    </div>
  </header>

  <!-- Loading State (Skeletons) -->
  @if (dashboard().isLoading) {
    <div class="dashboard-grid fade-in">
      <div class="skeleton-card summary-skeleton"></div>
      <div class="skeleton-card graph-skeleton"></div>
      <div class="assets-grid-skeleton">
        <div class="skeleton-card asset-skeleton" *ngFor="let i of [1,2,3,4]"></div>
      </div>
    </div>
  } @else {
    <!-- Real Data Dashboard -->
    <div class="dashboard-content fade-in">
      
      <!-- Financial Summary -->
      <section class="summary-section">
        <div class="card summary-card glass-card primary-gradient shadow-2xl">
          <div class="card-header">
            <h3>{{ 'dashboard.total_balance' | translate }}</h3>
            <lucide-icon [img]="icons.Wallet" size="20" class="card-icon"></lucide-icon>
          </div>
          <div class="balance-value">{{ formatCurrency(dashboard().totalValue) }}</div>
          <div class="pnl-chip" [class.positive]="dashboard().totalProfitLoss >= 0" [class.negative]="dashboard().totalProfitLoss < 0">
            {{ formatPercentage(dashboard().totalProfitLossPercentage) }}
            ({{ formatCurrency(dashboard().totalProfitLoss) }})
          </div>
        </div>
        
        <div class="card goal-card">
           <app-goal-progress 
             [currentBalance]="dashboard().totalValue"
             [profitLossPercentage]="dashboard().totalProfitLossPercentage">
           </app-goal-progress>
        </div>

        <div class="card chart-card glass-card">
          <app-portfolio-distribution [assets]="dashboard().assets"></app-portfolio-distribution>
        </div>

        <app-net-worth-chart class="net-worth-chart-wrapper"></app-net-worth-chart>

        <div class="card stats-card-v2 glass-card">
          <div class="stat-group">
            <div class="stat-badge investment">
              <lucide-icon [img]="icons.TrendingUp" size="24"></lucide-icon>
            </div>
            <div class="stat-info">
              <span class="label">{{ 'dashboard.total_investment' | translate }}</span>
              <span class="value">{{ formatCurrency(dashboard().totalInvestment) }}</span>
              <p class="sub-label">{{ 'dashboard.based_on' | translate }} {{ dashboard().assets.length }} {{ 'dashboard.assets' | translate }}</p>
            </div>
          </div>
          <div class="stat-group alternate">
             <div class="stat-badge count">
               <lucide-icon [img]="icons.Briefcase" size="24"></lucide-icon>
             </div>
             <div class="stat-info">
               <span class="label">{{ 'dashboard.diversification' | translate }}</span>
               <span class="value">{{ dashboard().assets.length }} {{ 'dashboard.assets' | translate }}</span>
             </div>
          </div>
        </div>
      </section>

      <!-- Assets Grid -->
      <div class="main-grid">
        <!-- Assets Grid -->
        <section class="assets-section">
          <div class="section-header">
            <h2>{{ 'dashboard.my_assets' | translate }}</h2>
            <button class="btn btn-sm btn-outline" (click)="openAddModal()">
              <lucide-icon [img]="icons.Plus" size="16"></lucide-icon> {{ 'dashboard.add_asset' | translate }}
            </button>
          </div>

          @if (isAddModalOpen()) {
            <app-add-asset-modal
              (close)="closeAddModal()"
              (assetAdded)="onAssetAdded($event)"
            ></app-add-asset-modal>
          }

          @if (dashboard().assets.length === 0) {
            <div class="empty-state glass-card">
              <p>{{ 'dashboard.empty_portfolio' | translate }}</p>
              <button class="btn btn-primary" (click)="openAddModal()">{{ 'dashboard.start_investing' | translate }}</button>
            </div>
          } @else {
            <div class="assets-grid">
              @for (asset of dashboard().assets; track asset.assetId) {
                <div class="asset-card glass-card slide-up">
                  <div class="asset-header">
                    <div class="asset-icon">
                      @if (asset.image) {
                        <img [src]="asset.image" [alt]="asset.name" (error)="asset.image = ''">
                      } @else {
                        <lucide-icon [img]="icons.CircleDollarSign" size="24"></lucide-icon>
                      }
                    </div>
                    <div class="asset-name">
                      <h4>{{ asset.name }}</h4>
                      <span class="symbol">{{ asset.symbol | uppercase }}</span>
                    </div>
                    <div class="asset-price">
                      {{ formatCurrency(asset.currentPrice) }}
                    </div>
                  </div>
                  
                  <div class="asset-body">
                    <div class="asset-metric">
                      <span>{{ 'dashboard.quantity' | translate }}</span>
                      <span>{{ asset.quantity }}</span>
                    </div>
                    <div class="asset-metric">
                      <span>{{ 'dashboard.value' | translate }}</span>
                      <span>{{ formatCurrency(asset.totalValue) }}</span>
                    </div>
                    <div class="asset-metric highlight" [class.positive]="asset.profitLoss >= 0" [class.negative]="asset.profitLoss < 0">
                      <span>P/L</span>
                      <span>{{ formatPercentage(asset.profitLossPercentage) }}</span>
                    </div>
                  </div>
                  
                  <div class="asset-actions">
                    <button class="btn-icon-sm" (click)="setPriceAlert(asset); $event.stopPropagation()" data-tooltip="Establecer Alerta">
                      <lucide-icon [img]="icons.Bell" size="16"></lucide-icon>
                    </button>
                    <button class="btn-icon-sm" (click)="openEditModal(asset); $event.stopPropagation()" [attr.data-tooltip]="'common.edit' | translate">
                      <lucide-icon [img]="icons.Pencil" size="16"></lucide-icon>
                    </button>
                    <button class="btn-icon-sm delete" (click)="openDeleteModal(asset); $event.stopPropagation()" [attr.data-tooltip]="'common.delete' | translate">
                      <lucide-icon [img]="icons.Trash2" size="16"></lucide-icon>
                    </button>
                  </div>
                </div>
              }
            </div>
          }
        </section>

        <!-- History Section -->
        <section class="history-section">
          <app-transaction-history></app-transaction-history>
        </section>
      </div>

      <!-- Edit Modal -->
      @if (editingAsset(); as asset) {
        @if (asset.id) {
          <app-edit-asset-modal
            [asset]="asset"
            [databaseId]="asset.id"
            (close)="closeEditModal()"
            (assetUpdated)="onAssetUpdated()"
          ></app-edit-asset-modal>
        }
      }

      <!-- Delete Modal -->
      @if (deletingAsset(); as asset) {
        <app-confirm-delete-modal
          [assetName]="asset.name"
          [isLoading]="isDeleting()"
          (cancel)="closeDeleteModal()"
          (confirm)="confirmDelete()"
        ></app-confirm-delete-modal>
      }
    </div>
  }

  <!-- Automation Center -->
  <app-automation-center 
    #automationCenter
    (openWhatIf)="openWhatIfCalculator()"
    (exportPdf)="exportToPDF()"
    (exportCsv)="exportToCSV()"
  ></app-automation-center>

  <!-- Alert Modal -->
  <app-alert-modal #alertModal></app-alert-modal>

  <!-- Notification Panel -->
  <div class="notification-overlay" *ngIf="isNotificationPanelOpen()">
    <div class="backdrop" (click)="closeNotifications()"></div>
    <div class="panel-container">
      <app-notification-panel 
        [notifications]="notifications()" 
        (close)="closeNotifications()">
      </app-notification-panel>
    </div>
  </div>

  <!-- What-If Calculator Modal -->
  <app-what-if-calculator #whatIfCalc></app-what-if-calculator>
</div>
