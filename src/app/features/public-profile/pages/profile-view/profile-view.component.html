<div class="public-profile-container fade-in" *ngIf="profile(); else loadingTpl">
  
  <header class="profile-page-header">
    <div class="profile-banner" [style.background]="profile()?.banner_colors ? 'linear-gradient(135deg, ' + profile()?.banner_colors![0] + ' 0%, ' + profile()?.banner_colors![1] + ' 50%, ' + profile()?.banner_colors![2] + ' 100%)' : null">
      <button class="btn-back-circle" (click)="goBack()" title="Regresar">
        <lucide-icon [img]="icons.ArrowLeft" size="20"></lucide-icon>
      </button>
    </div>
    
    <div class="profile-header-main">
      <div class="profile-identity-container">
        <div class="avatar-outer">
          <div class="avatar-wrapper">
             <img [src]="profile()?.avatar_url || ''" (error)="$event.target['src']=''" alt="Avatar" *ngIf="profile()?.avatar_url; else placeholder">
             <ng-template #placeholder>
               <div class="avatar placeholder">
                 {{ profile()?.name?.charAt(0)?.toUpperCase() || 'U' }}
               </div>
             </ng-template>
          </div>
          <div class="status-badge" *ngIf="isOwnProfile()">
             <lucide-icon [img]="icons.Shield" size="12"></lucide-icon>
          </div>
        </div>

        <div class="info-content">
          <div class="name-row">
            <h1>{{ profile()?.name }}</h1>
            <lucide-icon [img]="icons.Check" size="18" class="verified-icon" *ngIf="profile()?.privacy_settings?.show_assets"></lucide-icon>
          </div>
          <p class="username-text">@{{ profile()?.username }}</p>
        </div>
      </div>

      <div class="profile-actions">
        <!-- Smart Share Button -->
        <button class="btn-icon" (click)="shareProfile()" [disabled]="isGeneratingSnapshot()" data-tooltip="Compartir Perfil">
          @if (isGeneratingSnapshot()) {
            <span class="loading-spinner small"></span>
          } @else {
            <lucide-icon [img]="icons.Share2" size="20"></lucide-icon>
          }
        </button>

        <button 
          class="btn-follow" 
          [class.following]="isFollowing()"
          [disabled]="isProcessingFollow() || isOwnProfile()"
          (click)="toggleFollow()"
        >
          @if (isProcessingFollow()) {
            <span class="loading-spinner small"></span>
          } @else {
            <lucide-icon [img]="isFollowing() ? icons.Check : icons.Plus" size="18"></lucide-icon>
            {{ isFollowing() ? 'Siguiendo' : 'Seguir' }}
          }
        </button>
      </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar glass-card">
      <div class="stat-item">
        <div class="stat-icon followers">
          <lucide-icon [img]="icons.Users" size="18"></lucide-icon>
        </div>
        <div class="stat-data">
          <span class="label">Seguidores</span>
          <span class="value">{{ (profile()?.privacy_settings?.show_followers || isOwnProfile()) ? followerCount() : '--' }}</span>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-icon assets">
          <lucide-icon [img]="icons.Briefcase" size="18"></lucide-icon>
        </div>
        <div class="stat-data">
          <span class="label">Activos</span>
          <span class="value">{{ assets().length }}</span>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-icon performance">
          <lucide-icon [img]="icons.TrendingUp" size="18"></lucide-icon>
        </div>
        <div class="stat-data">
          <span class="label">Zenith Score</span>
          <span class="value">Excellence</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Content Grid -->
  <main class="profile-content">
    
    <section class="section-card portfolio-highlights glass-card">
      <div class="section-header">
        <div class="title-with-icon">
          <lucide-icon [img]="icons.Briefcase" size="20"></lucide-icon>
          <h2>Portafolio Público</h2>
        </div>
        <span class="privacy-badge" [class.locked]="!profile()?.privacy_settings?.show_assets">
           <lucide-icon [img]="profile()?.privacy_settings?.show_assets ? icons.Shield : icons.Lock" size="14"></lucide-icon> 
           {{ profile()?.privacy_settings?.show_assets ? 'Verificado' : 'Privado' }}
        </span>
      </div>

      <div class="assets-modern-grid" *ngIf="assets().length > 0; else emptyOrPrivate">
        <div class="asset-pill" *ngFor="let asset of assets()">
          <div class="pill-info">
            <span class="symbol">{{ asset.symbol }}</span>
            <span class="name">{{ asset.name }}</span>
          </div>
          <div class="pill-value">
            <span class="total">{{ formatCurrency(asset.value) }}</span>
            <span class="qty">{{ asset.quantity }} units</span>
          </div>
        </div>
      </div>

      <ng-template #emptyOrPrivate>
        <div class="empty-state">
           <lucide-icon [img]="icons.Shield" size="48" class="icon-muted"></lucide-icon>
           <p>La información detallada de este portafolio es privada.</p>
        </div>
      </ng-template>
    </section>

  <!-- Template for Downloadable Image (Hidden from view) -->
  <div class="share-card-container">
    <div id="share-card-template" class="share-card">
       <div class="card-banner" [style.background]="profile()?.banner_colors ? 'linear-gradient(135deg, ' + profile()?.banner_colors![0] + ' 0%, ' + profile()?.banner_colors![1] + ' 50%, ' + profile()?.banner_colors![2] + ' 100%)' : 'linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%)'">
         <div class="card-logo">ZENITH FINANCE</div>
       </div>
       <div class="card-body">
         <div class="card-avatar">
            <img [src]="profile()?.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + profile()?.name" alt="">
         </div>
         <div class="card-info">
            <h2>{{ profile()?.name }}</h2>
            <p>@{{ profile()?.username }}</p>
         </div>
         <div class="card-stats">
            <div class="card-stat">
               <span class="v">{{ followerCount() }}</span>
               <span class="l">Seguidores</span>
            </div>
            <div class="card-stat">
               <span class="v">{{ profile()?.privacy_settings?.show_assets ? assets().length : '--' }}</span>
               <span class="l">Activos</span>
            </div>
            <div class="card-stat">
               <span class="v highlight">85%</span>
               <span class="l">Score</span>
            </div>
         </div>
         <div class="card-footer">
            <span>zenith.finance/u/{{ profile()?.username }}</span>
         </div>
       </div>
    </div>
  </div>
  </main>
</div>

<ng-template #loadingTpl>
  <div class="loading-container">
    <div class="spinner"></div>
    <p>Cargando perfil...</p>
  </div>
</ng-template>
